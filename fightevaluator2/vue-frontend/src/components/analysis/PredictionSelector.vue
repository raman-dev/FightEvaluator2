
<script>function defaultPickValue (){ return {event:null,fighter:null};} </script>
<script setup>
import { useMatchupDetailStore } from "@/stores/matchupDetailStore";
import { ref, computed, watch, inject, onMounted } from "vue";
import PredictionSelectOption from "@/components/analysis/PredictionSelectOption.vue"

// props for dynamic data (you can change based on your setup)

const likelihoodLabelMap = inject('likelihoodLabelMap');

const props = defineProps({
  result: { type: Boolean, default: false },
  standardEvents: { type: Array, default: () => [] }, // [{ name, label, fighter_id }]
  matchup: { type: Object, default: () => ({ fighter_a: {}, fighter_b: {} }) },
  fighter_a: { type: Object, default: () => ({ last_name: "" }) },
  fighter_b: { type: Object, default: () => ({ last_name: "" }) },
  serverPick : { type: Object, default: defaultPickValue() },
  serverPredictions : {type: Array, default: () => []}
});


// local state
const selectorPick = ref(defaultPickValue());
const predictions = ref({});
const likelihood = ref(0);

// derived text for likelihood (you can extend styling/logic here)
const likelihoodText = computed(() => `Likelihood: ${likelihood.value}%`);
const { pickOutcome } = useMatchupDetailStore();//functions can be destructured from stores

onMounted(()=>{
  // console.log('serverPick:',newVal,oldVal);
    const {event,fighter} = props.serverPick;
    if (event === 'WIN'){
      //need fighter Id
      selectorPick.value = {fighter:fighter.id,event:event}
    }else{
      selectorPick.value = {event:event,fighter:null};
    }

    for (const p of props.serverPredictions) {
      
      const { event,likelihood } = p;
      console.log(event,likelihood);
      
      if (!(event in predictions.value) ){
        if (event === 'WIN'){
          predictions.value[event] = {};
        }
      }
      if (event === 'WIN'){
          predictions.value['WIN'][p.fighter] = { likelihood:likelihood, label:likelihoodLabelMap[likelihood]};
      }else{
          predictions.value[event] = {
            likelihood:likelihood,
            label : likelihoodLabelMap[likelihood]
          };
      }
  }
});


function savePrediction() {
  console.log("Saving prediction:", selectorPick.value);
  pickOutcome(selectorPick.value);
}

function isPickSame(){
    
    if (selectorPick.value.event !== props.serverPick.event){
      return false;
    }

    if (selectorPick.value.event === 'WIN'){
      return selectorPick.value.fighter === props.serverPick.fighter;
    }

    return true;
}

</script>

<template>
  <div class="prediction-result-container my-4">
    <div class="reveal-result-container">
      <template v-if="result">
        <p>Results Available!</p>
        <button class="btn btn-secondary reveal-result-btn">Reveal</button>
      </template>
      <template v-else>
        <p>Results not available yet</p>
        <button class="btn disabled btn-secondary reveal-result-btn">Reveal</button>
      </template>
    </div>

    <div class="prediction-selector" data-outcome-prediction-id="0" :data-prediction="selectorPick">
      <div class="title-container d-flex justify-content-between">
        <h2>Pick Outcome</h2>
        <button class="save-prediction-btn btn btn-primary" 
          :class="{ disabled: isPickSame() }" 
          @click="savePrediction">
            Save
        </button>
      </div>

      <!-- Bootstrap dropdown -->
      <div class="form-select-container">
        <form @submit.prevent class="m-0">
          <select class="form-select" v-model="selectorPick" name="pick" style="text-transform: capitalize;">
            <option :value="defaultPickValue()" data-event-type="NA" data-fighter-id="0">Choose Outcome</option>

            <template v-for="(event, idx) in standardEvents" :key="idx">
              <template v-if="event.value == 'WIN'">
                <PredictionSelectOption :fighter="fighter_a" :event="event.value" :label="event.name"></PredictionSelectOption>
                <PredictionSelectOption :fighter="fighter_b" :event="event.value" :label="event.name"></PredictionSelectOption>
              </template>
              <template v-else>
                <PredictionSelectOption :event="event.value" :label="event.name"></PredictionSelectOption>
              </template>
            </template>

          </select>
        </form>

        <div class="current-confidence d-flex align-items-center current-likelihood" :data-likelihood="likelihood">
          <p class="prediction-likelihood-text confidence my-0 w-100" :class="`likely-${likelihood}`"
            style="color:black;">
            {{ likelihoodText }}
          </p>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped lang="scss">
.prediction-result-container {
  display: flex;
  flex-direction: column;
  align-items: center;

  .form-select-container form select {
    border-bottom-left-radius: 0rem;
    border-bottom-right-radius: 0rem;
  }

  .prediction-selector {
    background-color: #12161A;
    border-radius: 0.8rem;
    outline: 3px solid transparent;
    outline-offset: 1px;

    padding: 1.2rem;
    height: fit-content;
    width: fit-content;

    .title-container {
      position: relative;
      margin-bottom: 0.5rem;
    }

    .title-container .save-prediction-btn {
      position: absolute;
      right: 0px;
      top: 0px;
    }

    .confidence {
      min-width: fit-content;
      border-radius: 0.4rem;
      border-top-left-radius: 0rem;
      border-top-right-radius: 0rem;
      padding: 0.3rem;
      text-align: center;
      text-transform: capitalize;
      font-family: PoppinsSemiBold;
    }
  }

  .prediction-selector.correct {
    outline-color: #00FF00;
  }

  .prediction-selector.incorrect {
    outline-color: #FF0000;
  }

  .reveal-result-container {
    display: flex;
    align-items: baseline;
    justify-content: space-between;

    p {
      margin-right: 1rem;
    }
  }
}
</style>
